import network
import urequests
import time
from machine import Pin

# ==== C·∫§U H√åNH THI·∫æT B·ªä ====
pir = Pin(5, Pin.IN)
led = Pin(6, Pin.OUT)
buzzer = Pin(16, Pin.OUT)

# ==== C·∫§U H√åNH WIFI ====
ssid = 'Miu'
password = 'tptn14082005'

# ==== PUSHSAFER PRIVATE KEY ====
PUSHSAFER_KEY = 'UGOfXqvXUwLMzEPDWS4Q'  # thay b·∫±ng m√£ c·ªßa b·∫°n

# ==== K·∫æT N·ªêI WIFI ====
def connect_wifi():
    wifi = network.WLAN(network.STA_IF)
    wifi.active(True)
    if not wifi.isconnected():
        print(" ƒêang k·∫øt n·ªëi WiFi...")
        wifi.connect(ssid, password)
        while not wifi.isconnected():
            time.sleep(0.5)
    print(" WiFi ƒë√£ k·∫øt n·ªëi:", wifi.ifconfig())

# ==== G·ª¨I TH√îNG B√ÅO PUSHSAFER ====
def send_push_notification():
    url = "https://www.pushsafer.com/api"
    headers = {"Content-Type": "application/x-www-form-urlencoded"}
    data = f"k={PUSHSAFER_KEY}&m=üö® Ph√°t hi·ªán chuy·ªÉn ƒë·ªông!&t=ESP32 B√°o ƒë·ªông&d=0"
    try:
        print(" G·ª≠i th√¥ng b√°o PushSafer...")
        response = urequests.post(url, data=data, headers=headers)
        print(" Ph·∫£n h·ªìi:", response.text)
        response.close()
    except Exception as e:
        print(" L·ªói g·ª≠i th√¥ng b√°o:", e)

# ==== V√íNG L·∫∂P CH√çNH ====
def main():
    connect_wifi()
    last_notify_time = 0

    while True:
        if pir.value() == 1:
            print(" Ph√°t hi·ªán chuy·ªÉn ƒë·ªông!")
            led.on()
            buzzer.on()

            current_time = time.ticks_ms()
            if time.ticks_diff(current_time, last_notify_time) > 10000:
                send_push_notification()
                last_notify_time = current_time

            time.sleep(2)  # B·∫≠t 2 gi√¢y
            led.off()
            buzzer.off()

        time.sleep(0.05)  # Ki·ªÉm tra l·∫°i nhanh

main()
